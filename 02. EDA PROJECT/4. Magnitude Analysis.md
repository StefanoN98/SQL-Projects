# âš–ï¸ Magnitude Analysis

This section focuses on measuring and comparing the scale or intensity of variables or events, aiming to quantify which elements have the greatest impact within a dataset or system.



---
## ðŸ“‹ Table of Contents
1. *** 
2. ****
3. *******
---

## ðŸ“Œ Purpose

- âœ… *********
- âœ… ********
- âœ… ********
- âœ… ****

---

## Product Revenue and Price Comparison by Category
```sql
SELECT dp.product_category_name,
	   dp.product_id,
	   ROUND(AVG(MIN(oi.item_price)) OVER (PARTITION BY dp.product_category_name),2) AS avg_price_per_category,
	   MIN(oi.item_price) AS item_price, --use min because of price changes due to promotions/offers
	   COUNT(DISTINCT oi.order_id) AS total_orders,
	   CAST(MIN(item_price) * COUNT(DISTINCT oi.order_id) AS varchar)+'â‚¬' AS total_revenue,
	   CASE 
		WHEN MIN(item_price) > ROUND(AVG(MIN(oi.item_price)) OVER (PARTITION BY dp.product_category_name),2) THEN 'Above'
		ELSE 'Below'
	   END AS category_avg_price_comparison
FROM gold.dim_products dp
JOIN gold.fact_order_items oi ON dp.product_id=oi.product_id
GROUP BY dp.product_category_name, dp.product_id
ORDER BY MIN(item_price) * COUNT(DISTINCT oi.order_id) DESC
--ORDER BY dp.product_category_name, MIN(item_price) * COUNT(DISTINCT oi.order_id) DESC
```

| product_category_name   | product_id                       | avg_price_per_category | item_price | total_orders | total_revenue | category_avg_price_comparison |
|------------------------|--------------------------------|------------------------|------------|--------------|---------------|-------------------------------|
| health_beauty          | bb50f2e236e5eea0100680137654686c | 144.79                 | 325        | 187          | 60775â‚¬        | Above                         |
| health_beauty          | 6cdd53843498f92890544667809f1595 | 144.79                 | 299        | 151          | 45149â‚¬        | Above                         |
| computers              | d6160fb7873f184099d9bc95e30376af | 1333.55                | 1200       | 35           | 42000â‚¬        | Below                         |
| computers_accessories  | 3dd2a17168ec895c781a9191c1e95ad7 | 153.23                 | 149.9      | 255          | 38224.5â‚¬      | Below                         |
| baby                   | 25c38557cf793876c5abdd5931f922db | 165.4                  | 949.9      | 38           | 36096.2â‚¬      | Above                         |

---
## Customer Spending Behavior and Purchased Categories Analysis
```sql
WITH customer_spending_summary AS (
  -- Calculate for each customer total orders, average spending, total spending and classification
  SELECT dc.customer_unique_id,
         COUNT(DISTINCT fo.order_id) AS total_orders,
         AVG(fp.total) AS average_spent_by_customer,
         SUM(fp.total) AS total_revenue,
         CASE
           WHEN AVG(fp.total) = SUM(fp.total) AND SUM(fp.total) >= 1000 THEN 'High-value one-time purchaser'
           WHEN AVG(fp.total) = SUM(fp.total) AND SUM(fp.total) < 1000 THEN 'Low-value one-time purchaser'
           WHEN AVG(fp.total) <> SUM(fp.total) AND SUM(fp.total) >= 1000 THEN 'High-spending repeat customer'
           ELSE 'Low-spending repeat customer'
         END AS customer_classification
  FROM gold.dim_customers dc
  JOIN gold.fact_orders fo ON dc.customer_id = fo.customer_id
  JOIN gold.fact_payments fp ON fp.order_id = fo.order_id
  GROUP BY dc.customer_unique_id
),

customer_purchased_categories AS (
  -- Find all the product categories purchased by customers
  SELECT DISTINCT 
      dc.customer_unique_id,
      dp.product_category_name
  FROM gold.dim_customers dc
  JOIN gold.fact_orders fo ON dc.customer_id = fo.customer_id
  LEFT JOIN gold.fact_order_items oi ON oi.order_id = fo.order_id
  JOIN gold.dim_products dp ON dp.product_id = oi.product_id
),

customer_categories_aggregated AS (
  -- Aggregate all the product categories purchased by customer in an unique column
  SELECT 
      customer_unique_id,
      STRING_AGG(product_category_name, ', ') AS purchased_categories
  FROM customer_purchased_categories
  GROUP BY customer_unique_id
)

SELECT css.customer_unique_id,
       css.total_orders,
       css.average_spent_by_customer,
       css.total_revenue,
       css.customer_classification,
       cca.purchased_categories
FROM customer_spending_summary css
JOIN customer_categories_aggregated cca ON css.customer_unique_id = cca.customer_unique_id
ORDER BY css.total_revenue DESC
```

| customer_unique_id                     | total_orders | average_spent_by_customer | total_revenue | customer_classification       | purchased_categories                          |
|--------------------------------------|--------------|---------------------------|---------------|-------------------------------|-----------------------------------------------|
| 28f6c5e53f39cd45ccd6b22fc82cd1d1     | 1            | 2022.02                   | 2022.02       | High-value one-time purchaser  | musical_instruments                           |
| 906a8a4ec9f3d4c3e64fa6d1c4fe6009     | 2            | 1010.43                   | 2020.86       | High-spending repeat customer  | agro_industry_and_commerce, housewares       |
| c8460e4251689ba205045f3ea17884a1     | 4            | 1163.98                   | 4655.91       | High-spending repeat customer  | telephony                                     |
| 7958596630af55cc19f381713019fab8     | 1            | 41.69                     | 41.69         | Low-value one-time purchaser   | fashion_bags_accessories                      |
| 7a43947421cb96e7abe1e0572ccac62b     | 1            | 41.69                     | 41.69         | Low-value one-time purchaser   | housewares                                   |
