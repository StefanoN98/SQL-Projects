# ⚖️ Magnitude Analysis

This section focuses on measuring and comparing the scale or intensity of variables or events, aiming to quantify which elements have the greatest impact within a dataset or system.



---
## 📋 Table of Contents
1. [Product Revenue and Price Comparison by Category](#product-revenue-and-price-comparison-by-category)
2. [Customer Spending Behavior and Purchased Categories Analysis](#customer-spending-behavior-and-purchased-categories-analysis)
3. [Seller Performance and Classification Analysis](#seller-performance-and-classification-analysis)

---

## 📌 Purpose
- ✅ Evaluate product performance by analyzing revenue and price across categories.
- ✅ Segment customers based on transactional behavior and spending metrics.
- ✅ Aggregate and interpret customer purchase diversity to identify key product category engagement.
- ✅ Categorize seller using key operational and financial metrics to inform strategic decisions.
---

## Product Revenue and Price Comparison by Category
This query calculates the item price, total orders and revenue per product, comparing each product’s price to the average price in its category. It helps the business identify which products are priced above or below their category average, supporting pricing strategy and revenue optimization.
```sql
SELECT dp.product_category_name,
	   dp.product_id,
	   ROUND(AVG(MIN(oi.item_price)) OVER (PARTITION BY dp.product_category_name),2) AS avg_price_per_category,
	   MIN(oi.item_price) AS item_price, --use min because of price changes due to promotions/offers
	   COUNT(DISTINCT oi.order_id) AS total_orders,
	   CAST(MIN(item_price) * COUNT(DISTINCT oi.order_id) AS varchar)+'€' AS total_revenue,
	   CASE 
		WHEN MIN(item_price) > ROUND(AVG(MIN(oi.item_price)) OVER (PARTITION BY dp.product_category_name),2) THEN 'Above'
		ELSE 'Below'
	   END AS category_avg_price_comparison
FROM gold.dim_products dp
JOIN gold.fact_order_items oi ON dp.product_id=oi.product_id
GROUP BY dp.product_category_name, dp.product_id
ORDER BY MIN(item_price) * COUNT(DISTINCT oi.order_id) DESC
--ORDER BY dp.product_category_name, MIN(item_price) * COUNT(DISTINCT oi.order_id) DESC
```

| product_category_name   | product_id                       | avg_price_per_category | item_price | total_orders | total_revenue | category_avg_price_comparison |
|------------------------|--------------------------------|------------------------|------------|--------------|---------------|-------------------------------|
| health_beauty          | bb50f2e236e5eea0100680137654686c | 144.79                 | 325        | 187          | 60775€        | Above                         |
| health_beauty          | 6cdd53843498f92890544667809f1595 | 144.79                 | 299        | 151          | 45149€        | Above                         |
| computers              | d6160fb7873f184099d9bc95e30376af | 1333.55                | 1200       | 35           | 42000€        | Below                         |
| computers_accessories  | 3dd2a17168ec895c781a9191c1e95ad7 | 153.23                 | 149.9      | 255          | 38224.5€      | Below                         |
| baby                   | 25c38557cf793876c5abdd5931f922db | 165.4                  | 949.9      | 38           | 36096.2€      | Above                         |

### Remarks:
- **Revenue Performance Analysis**: the query identifies top revenue-generating products by combining unit pricing with order volume, helping prioritize high-impact products for inventory management and marketing focus.
-  **Category Price Positioning Strategy**: By comparing individual product prices against category averages, it reveals which products are positioned as premium or value offerings within their respective categories, supporting pricing strategy decisions.

---
## Customer Spending Behavior and Purchased Categories Analysis
This query segments customers by their spending patterns and purchase frequency, summarizing their total revenue and product categories bought. It supports targeted marketing and customer loyalty efforts.
```sql
WITH customer_spending_summary AS (
  -- Calculate for each customer total orders, average spending, total spending and classification
  SELECT dc.customer_unique_id,
         COUNT(DISTINCT fo.order_id) AS total_orders,
         AVG(fp.total) AS average_spent_by_customer,
         SUM(fp.total) AS total_revenue,
         CASE
           WHEN AVG(fp.total) = SUM(fp.total) AND SUM(fp.total) >= 1000 THEN 'High-value one-time purchaser'
           WHEN AVG(fp.total) = SUM(fp.total) AND SUM(fp.total) < 1000 THEN 'Low-value one-time purchaser'
           WHEN AVG(fp.total) <> SUM(fp.total) AND SUM(fp.total) >= 1000 THEN 'High-spending repeat customer'
           ELSE 'Low-spending repeat customer'
         END AS customer_classification
  FROM gold.dim_customers dc
  JOIN gold.fact_orders fo ON dc.customer_id = fo.customer_id
  JOIN gold.fact_payments fp ON fp.order_id = fo.order_id
  GROUP BY dc.customer_unique_id
),

customer_purchased_categories AS (
  -- Find all the product categories purchased by customers
  SELECT DISTINCT 
      dc.customer_unique_id,
      dp.product_category_name
  FROM gold.dim_customers dc
  JOIN gold.fact_orders fo ON dc.customer_id = fo.customer_id
  LEFT JOIN gold.fact_order_items oi ON oi.order_id = fo.order_id
  JOIN gold.dim_products dp ON dp.product_id = oi.product_id
),

customer_categories_aggregated AS (
  -- Aggregate all the product categories purchased by customer in an unique column
  SELECT 
      customer_unique_id,
      STRING_AGG(product_category_name, ', ') AS purchased_categories
  FROM customer_purchased_categories
  GROUP BY customer_unique_id
)

SELECT css.customer_unique_id,
       css.total_orders,
       css.average_spent_by_customer,
       css.total_revenue,
       css.customer_classification,
       cca.purchased_categories
FROM customer_spending_summary css
JOIN customer_categories_aggregated cca ON css.customer_unique_id = cca.customer_unique_id
ORDER BY css.total_revenue DESC
```

| customer_unique_id                     | total_orders | average_spent_by_customer | total_revenue | customer_classification       | purchased_categories                          |
|--------------------------------------|--------------|---------------------------|---------------|-------------------------------|-----------------------------------------------|
| 28f6c5e53f39cd45ccd6b22fc82cd1d1     | 1            | 2022.02                   | 2022.02       | High-value one-time purchaser  | musical_instruments                           |
| 906a8a4ec9f3d4c3e64fa6d1c4fe6009     | 2            | 1010.43                   | 2020.86       | High-spending repeat customer  | agro_industry_and_commerce, housewares       |
| c8460e4251689ba205045f3ea17884a1     | 4            | 1163.98                   | 4655.91       | High-spending repeat customer  | telephony                                     |
| 7958596630af55cc19f381713019fab8     | 1            | 41.69                     | 41.69         | Low-value one-time purchaser   | fashion_bags_accessories                      |
| 7a43947421cb96e7abe1e0572ccac62b     | 1            | 41.69                     | 41.69         | Low-value one-time purchaser   | housewares                                   |

### Remarks:
- **Customer Segmentation & Value Optimization**: The query creates a comprehensive customer classification system (high/low value × one-time/repeat) enabling targeted retention strategies.
- **Purchase Behavior & Revenue Pattern Analysis**: By examining order frequency and customer spending amounts, the analysis reveals purchasing behaviors and helps identify what types of products customers are seeking, enabling better understanding of customer preferences and more targeted product positioning strategies.
---

## Seller Performance and Classification Analysis
This query evaluates sellers by their sales volume, revenue, and customer reach, then classifies them into four performance categories based on median benchmarks. It helps identify top performers and tailor seller support or strategies accordingly.
```sql
WITH seller_performance AS (
	-- Calculates for each seller the number of products available, total orders, customers served, total revenue and avg revenue per order
	SELECT ds.seller_id,
		   COUNT(DISTINCT oi.product_id) AS products_available,
		   COUNT(DISTINCT oi.order_id) AS total_orders,
		   COUNT(DISTINCT dc.customer_unique_id) AS customers_served,
		   SUM(oi.total_order_payment) AS total_revenue,
		   ROUND(AVG(oi.total_order_payment),2) AS avg_revenue_per_order
	FROM gold.dim_sellers ds
	JOIN gold.fact_order_items oi ON ds.seller_id=oi.seller_id
	JOIN gold.fact_orders fo ON fo.order_id=oi.order_id
	JOIN gold.dim_customers dc ON dc.customer_id=fo.customer_id
	GROUP BY ds.seller_id
),

seller_totals AS (
	-- Calculates for each seller the total number of orders and total revenue (without customer or product details)
	SELECT 
        ds.seller_id,
        COUNT(DISTINCT oi.order_id) AS total_orders,
        SUM(oi.total_order_payment) AS total_revenue
    FROM gold.dim_sellers ds
    JOIN gold.fact_order_items oi ON ds.seller_id = oi.seller_id
    GROUP BY ds.seller_id
),

seller_medians AS (
	-- Calculates the median number of orders and median revenue across all sellers to set reference values
    	-- (the medians are used to classify sellers)
    	SELECT
		seller_id,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY total_orders) OVER () AS median_orders,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY total_revenue) OVER () AS median_revenue
    	FROM seller_totals
)

SELECT sp.seller_id,
	   sp.products_available,
	   sp.total_orders,
	   sp.customers_served,
	   sp.total_revenue,
	   sp.avg_revenue_per_order,
	   CASE
        WHEN sp.total_orders >= sm.median_orders AND sp.total_revenue >= sm.median_revenue THEN 'Top Seller'
        WHEN sp.total_orders < sm.median_orders AND sp.total_revenue >= sm.median_revenue THEN 'Niche Seller'
        WHEN sp.total_orders >= sm.median_orders AND sp.total_revenue < sm.median_revenue THEN 'Mass Seller'
        ELSE 'Low Impact Seller'
    END AS seller_class
FROM seller_performance sp
JOIN seller_medians sm ON sp.seller_id = sm.seller_id;
```

| seller_id                            | products_available | total_orders | customers_served | total_revenue | avg_revenue_per_order | seller_class       |
|------------------------------------|--------------------|--------------|------------------|---------------|----------------------|--------------------|
| 0241d4d5d36f10f80c644447315af0bd   | 56                 | 238          | 235              | 38251,61      | 155,49               | Top Seller         |
| 0249d282d911d23cb8b869ab49c99f53   | 4                  | 11           | 11               | 531,88        | 48,35                | Mass Seller        |
| 024b564ae893ce8e9bfa02c10a401ece   | 2                  | 2            | 2                | 918,4         | 114,8                | Low Impact Seller  |
| 01ed254b9ff8407dfb9d99ba1e17d923   | 2                  | 5            | 5                | 1533,71       | 306,74               | Niche Seller       |
| 0bae85eb84b9fb3bd773911e89288d54   | 45                 | 137          | 135              | 10406,4       | 71,28                | Top Seller         |
