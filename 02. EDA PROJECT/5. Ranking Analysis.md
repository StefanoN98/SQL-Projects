# 🏆 Rank Analysis

This section analyzes and ranks key entities (e.g., products, customers) based on performance metrics, enabling comparison and identification of top and low performers
> 💡 This script targets the `Brazilian E-Commerce Dataset` used in the [data warehouse project](https://github.com/StefanoN98/SQL-Project-E-Commerce-Case/blob/613ab33460a9f2584cea7d442ed4edf4a987d2bc/01.%20DATA%20WAREHOUSE%20PROJECT/01.%20DWH%20README.md)

---
## 📋 Table of Contents
1. [Product Revenue and Price Comparison by Category](#product-revenue-and-price-comparison-by-category)
2. [Customer Spending Behavior and Purchased Categories Analysis](#customer-spending-behavior-and-purchased-categories-analysis)
3. [Seller Performance and Classification Analysis](#seller-performance-and-classification-analysis)

---

## 📌 Purpose
- ✅ ****
- ✅ ****
- ✅ ****
- ✅ ****
  
---

## Top 3 products per category analysis
This query ranks products by revenue within each category, keeps only the top three, calculates their revenue share, and classifies them into performance segments. It helps identify top performers, niche items, and supports strategic decisions.

```sql
WITH category_totals AS (
	SELECT product_category_name,
		   SUM(oi.total_order_payment) AS category_total
	FROM gold.dim_products dp
	JOIN gold.fact_order_items oi ON dp.product_id = oi.product_id
	JOIN gold.fact_orders fo ON fo.order_id = oi.order_id
	WHERE YEAR(fo.order_purchase_timestamp) = 2017 AND fo.order_status NOT IN ('unavailable','canceled')
	GROUP BY product_category_name
),
ranked_products AS (
	SELECT 
		dp.product_category_name,
		dp.product_id,
		COUNT(DISTINCT oi.order_id) AS num_orders,
		SUM(oi.total_order_payment) AS total_revenue,
		AVG(oi.total_order_payment) AS avg_revenue_per_order,
		RANK() OVER (PARTITION BY dp.product_category_name ORDER BY SUM(oi.total_order_payment) DESC) AS SalesRank
	FROM gold.dim_products dp
	JOIN gold.fact_order_items oi ON dp.product_id=oi.product_id
	JOIN gold.fact_orders fo ON fo.order_id=oi.order_id
	WHERE YEAR(fo.order_purchase_timestamp) = 2017 AND fo.order_status NOT IN ('unavailable','canceled')
	GROUP BY dp.product_category_name, dp.product_id
),

thresholds AS(
	SELECT AVG(num_orders * 1.0) AS avg_orders,
			AVG(avg_revenue_per_order) AS avg_avg_revenue
	FROM ranked_products
)

SELECT 
	rp.product_category_name,
	rp.product_id,
	CONCAT('Top ', SalesRank) AS ranking,
	num_orders,
	total_revenue,
	ROUND(avg_revenue_per_order, 2) AS avg_revenue_per_order,
	CAST(ROUND(100.0 * total_revenue / ct.category_total, 2) AS varchar) + '%' AS revenue_share_in_category_pct,
    CASE
        WHEN num_orders < t.avg_orders AND avg_revenue_per_order >= t.avg_avg_revenue THEN 'Premium Product'
        WHEN num_orders >= t.avg_orders AND avg_revenue_per_order < t.avg_avg_revenue THEN 'Best-seller'
        WHEN num_orders >= t.avg_orders AND avg_revenue_per_order >= t.avg_avg_revenue THEN 'Top Performer'
        ELSE 'Niche/Occasional'
    END AS product_type
FROM ranked_products rp
JOIN category_totals ct ON rp.product_category_name = ct.product_category_name
CROSS JOIN thresholds t
WHERE SalesRank <= 3
ORDER BY product_category_name, SalesRank;
```

| product_category_name | product_id                             | ranking | num_orders | total_revenue | avg_revenue_per_order | revenue_share_in_category_pct | product_type       |
|------------------------|----------------------------------------|---------|------------|---------------|------------------------|--------------------------------|--------------------|
| air_conditioning       | 12485f9cdebb6ca179826ede539554ad     | Top 1   | 4          | 3993,09       | 798,62                 | 12,94%                         | Top Performer      |
| air_conditioning       | 83ca77d87b187321faaee535adbce26c     | Top 2   | 3          | 2526,58       | 842,19                 | 8,19%                          | Top Performer      |
| air_conditioning       | f0f2af23f970208fe4132a77aca3c63f     | Top 3   | 1          | 1517,70       | 758,85                 | 4,92%                          | Premium Product    |
| art                    | 1bdf5e6731585cf01aa8169c7028d6ad     | Top 1   | 1          | 6726,66       | 6726,66                | 65,31%                         | Premium Product    |
| art                    | 986700c98805af229ab7ad51b95fa356     | Top 2   | 2          | 397,42        | 56,77                  | 3,86%                          | Niche/Occasional   |
| art                    | 986c47683f9e701e110a0cc525dfac87     | Top 3   | 3          | 388,73        | 129,58                 | 3,77%                          | Best-seller        |

