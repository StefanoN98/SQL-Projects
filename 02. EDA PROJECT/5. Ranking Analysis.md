# 🏆 Rank Analysis

This section analyzes and ranks key entities (e.g., products, customers) based on performance metrics, enabling comparison and identification of top and low performers
> 💡 This script targets the `Brazilian E-Commerce Dataset` used in the [data warehouse project](https://github.com/StefanoN98/SQL-Project-E-Commerce-Case/blob/613ab33460a9f2584cea7d442ed4edf4a987d2bc/01.%20DATA%20WAREHOUSE%20PROJECT/01.%20DWH%20README.md)

---
## 📋 Table of Contents
1. [Top 3 products per category analysis](#product-revenue-and-price-comparison-by-category)
2. [Customer Spending Behavior and Purchased Categories Analysis](#customer-spending-behavior-and-purchased-categories-analysis)
3. [Seller Performance and Classification Analysis](#seller-performance-and-classification-analysis)

---

## 📌 Purpose
- ✅ ****
- ✅ ****
- ✅ ****
- ✅ ****
  
---

## Top 3 products per category analysis
This query ranks products by revenue within each category, keeps only the top three, calculates their revenue share, and classifies them into performance segments. It helps identify top performers, niche items, and supports strategic decisions.

```sql
WITH category_totals AS (
	SELECT product_category_name,
		   SUM(oi.total_order_payment) AS category_total
	FROM gold.dim_products dp
	JOIN gold.fact_order_items oi ON dp.product_id = oi.product_id
	JOIN gold.fact_orders fo ON fo.order_id = oi.order_id
	WHERE YEAR(fo.order_purchase_timestamp) = 2017 AND fo.order_status NOT IN ('unavailable','canceled')
	GROUP BY product_category_name
),
ranked_products AS (
	SELECT 
		dp.product_category_name,
		dp.product_id,
		COUNT(DISTINCT oi.order_id) AS num_orders,
		SUM(oi.total_order_payment) AS total_revenue,
		AVG(oi.total_order_payment) AS avg_revenue_per_order,
		RANK() OVER (PARTITION BY dp.product_category_name ORDER BY SUM(oi.total_order_payment) DESC) AS SalesRank
	FROM gold.dim_products dp
	JOIN gold.fact_order_items oi ON dp.product_id=oi.product_id
	JOIN gold.fact_orders fo ON fo.order_id=oi.order_id
	WHERE YEAR(fo.order_purchase_timestamp) = 2017 AND fo.order_status NOT IN ('unavailable','canceled')
	GROUP BY dp.product_category_name, dp.product_id
),

thresholds AS(
	SELECT AVG(num_orders * 1.0) AS avg_orders,
			AVG(avg_revenue_per_order) AS avg_avg_revenue
	FROM ranked_products
)

SELECT 
	rp.product_category_name,
	rp.product_id,
	CONCAT('Top ', SalesRank) AS ranking,
	num_orders,
	total_revenue,
	ROUND(avg_revenue_per_order, 2) AS avg_revenue_per_order,
	CAST(ROUND(100.0 * total_revenue / ct.category_total, 2) AS varchar) + '%' AS revenue_share_in_category_pct,
    CASE
        WHEN num_orders < t.avg_orders AND avg_revenue_per_order >= t.avg_avg_revenue THEN 'Premium Product'
        WHEN num_orders >= t.avg_orders AND avg_revenue_per_order < t.avg_avg_revenue THEN 'Best-seller'
        WHEN num_orders >= t.avg_orders AND avg_revenue_per_order >= t.avg_avg_revenue THEN 'Top Performer'
        ELSE 'Niche/Occasional'
    END AS product_type
FROM ranked_products rp
JOIN category_totals ct ON rp.product_category_name = ct.product_category_name
CROSS JOIN thresholds t
WHERE SalesRank <= 3
ORDER BY product_category_name, SalesRank;
```

| product_category_name | product_id                             | ranking | num_orders | total_revenue | avg_revenue_per_order | revenue_share_in_category_pct | product_type       |
|------------------------|----------------------------------------|---------|------------|---------------|------------------------|--------------------------------|--------------------|
| air_conditioning       | 12485f9cdebb6ca179826ede539554ad     | Top 1   | 4          | 3993,09       | 798,62                 | 12,94%                         | Top Performer      |
| air_conditioning       | 83ca77d87b187321faaee535adbce26c     | Top 2   | 3          | 2526,58       | 842,19                 | 8,19%                          | Top Performer      |
| air_conditioning       | f0f2af23f970208fe4132a77aca3c63f     | Top 3   | 1          | 1517,70       | 758,85                 | 4,92%                          | Premium Product    |
| art                    | 1bdf5e6731585cf01aa8169c7028d6ad     | Top 1   | 1          | 6726,66       | 6726,66                | 65,31%                         | Premium Product    |
| art                    | 986700c98805af229ab7ad51b95fa356     | Top 2   | 2          | 397,42        | 56,77                  | 3,86%                          | Niche/Occasional   |
| art                    | 986c47683f9e701e110a0cc525dfac87     | Top 3   | 3          | 388,73        | 129,58                 | 3,77%                          | Best-seller        |

### Remarks:

---

## Top 10 customer per revenue
This query identifies the top 10 customers by total spending, counting their orders and ranking them by revenue. It also lists the product categories and IDs they purchased. This helps the business target high-value customers.

```sql
WITH customer_revenue AS (
    SELECT 
        dc.customer_unique_id,
        COUNT(DISTINCT fo.order_id) AS num_orders,
        SUM(fp.total) AS total_payment,
        RANK() OVER (ORDER BY SUM(fp.total) DESC) AS revenue_rank
    FROM gold.dim_customers dc
    JOIN gold.fact_orders fo ON dc.customer_id = fo.customer_id
    JOIN gold.fact_payments fp ON fp.order_id = fo.order_id
    WHERE fo.order_status NOT IN ('canceled', 'unavailable')
    GROUP BY dc.customer_unique_id
),

customer_products AS (
    SELECT 
        customer_unique_id,
        STRING_AGG(product_category_name, ', ') AS product_categories,
		STRING_AGG(product_id, ' // ') AS product_id
    FROM (
        SELECT DISTINCT 
            dc.customer_unique_id,
            dp.product_category_name,
			dp.product_id
        FROM gold.dim_customers dc
        JOIN gold.fact_orders fo ON dc.customer_id = fo.customer_id
        JOIN gold.fact_order_items oi ON oi.order_id = fo.order_id
        JOIN gold.dim_products dp ON dp.product_id = oi.product_id
        WHERE fo.order_status NOT IN ('canceled', 'unavailable')
    ) AS distinct_categories
    GROUP BY customer_unique_id
)

SELECT 
    cr.revenue_rank AS rank,
	cr.customer_unique_id,
    cr.num_orders,
    cr.total_payment,
    cp.product_categories,
	cp.product_id
FROM customer_revenue cr
LEFT JOIN customer_products cp 
    ON cr.customer_unique_id = cp.customer_unique_id
WHERE cr.revenue_rank <= 10
ORDER BY cr.revenue_rank;
```

| rank | customer_unique_id                     | num_orders | total_payment | product_categories                       | product_id                                                   |
|------|---------------------------------------|------------|---------------|-----------------------------------------|--------------------------------------------------------------|
| 1    | 0a0a92112bd4c708ca5fde585afaa872     | 1          | 13664,08     | fixed_telephony                          | 5769ef0a239114ac3a854af00df129e4                             |
| 2    | da122df9eeddfedc1dc1f5349a1a690c     | 2          | 7571,63      | small_appliances, small_appliances      | 3ecf69ee1fe21cfd40b30cbea549e563, a6492cc69376c469ab6f61d8f44de961 |
| 3    | 763c8b1c9c68a0229c42c9fc6f662b93     | 1          | 7274,88      | fixed_telephony                          | 19936fa4f614ee0590d3b77ac83fd648                             |
| 4    | dc4802a71eae9be1dd28f5d788ceb526     | 1          | 6929,31      | housewares                               | 489ae2aa008f021502940f251d4cce7f                             |
| 5    | 459bef486812aa25204be022145caa62     | 1          | 6922,21      | computers                                | 69c590f7ffc7bf8db97190b6cb6ed62                              |
| 6    | ff4159b92c40ebe40454e3e6a7c35ed6     | 1          | 6726,66      | art                                      | 1bdf5e6731585cf01aa8169c7028d6ad                             |
| 7    | 4007669dec559734d6f53e029e360987     | 1          | 6081,54      | agro_industry_and_commerce               | c183fd5d2abf05873fa6e1014ed9e06c                             |
| 8    | eebb5dda148d3893cdaf5b5ca3040ccb     | 1          | 4764,34      | small_appliances                          | c3ed642d592594bb648ff4a04cee2747                             |
| 9    | 48e1ac109decbb87765a3eade6854098     | 1          | 4681,78      | computers                                | 259037a6a41845e455183f89c5035f18                             |
| 10   | c8460e4251689ba205045f3ea17884a1     | 4          | 4655,91      | telephony                                | e7cc48a9daff5436f63d3aad9426f28b                             |

### Remarks:

---

## IMDB Style Rating
This query calculates a weighted product rating, similar to IMDb’s weighted rating, to make review scores more robust, especially for products with few reviews
```sql
WITH cte AS (
    -- seleziono tutte le review per ordini con un solo prodotto
    SELECT 
        fr.order_id,
        fr.review_score,
        oi.product_id
    FROM gold.fact_reviews fr
    JOIN gold.fact_order_items oi 
        ON fr.order_id = oi.order_id
    WHERE oi.order_item_id <= 1
),

global_avg_cte AS (
    SELECT AVG(review_score * 1.0) AS global_avg FROM cte -- The global average is 4.107
),

product_reviews AS (
    SELECT 
        dp.product_id,
        COUNT(cte.review_score) AS total_reviews,
        CAST(AVG(cte.review_score * 1.0) AS DECIMAL(3,1)) AS average_score,
        COUNT(CASE WHEN cte.review_score = 1 THEN 1 END) AS _1_Star,
        COUNT(CASE WHEN cte.review_score = 2 THEN 1 END) AS _2_Star,
        COUNT(CASE WHEN cte.review_score = 3 THEN 1 END) AS _3_Star,
        COUNT(CASE WHEN cte.review_score = 4 THEN 1 END) AS _4_Star,
        COUNT(CASE WHEN cte.review_score = 5 THEN 1 END) AS _5_Star
    FROM gold.dim_products dp
    JOIN cte ON dp.product_id = cte.product_id
    GROUP BY dp.product_id
)

SELECT 
    pr.*,
    ROUND((
        (CAST(pr.total_reviews AS FLOAT) / (pr.total_reviews + 5)) * pr.average_score +
        (5.0 / (pr.total_reviews + 5)) * ga.global_avg
    ), 2) AS weighted_rating
FROM product_reviews pr
CROSS JOIN global_avg_cte ga
ORDER BY weighted_rating DESC;
```

| product_id                             | total_reviews | average_score | _1_Star | _2_Star | _3_Star | _4_Star | _5_Star | weighted_rating |
|----------------------------------------|---------------|---------------|---------|---------|---------|---------|---------|----------------|
| 3e4176d545618ed02f382a3057de32b4     | 24            | 5,0           | 0       | 0       | 0       | 1       | 23      | 4,85           |
| e7f85e7f0203b7b95cc1b4c21b4b070c     | 21            | 4,9           | 0       | 0       | 1       | 1       | 19      | 4,75           |
| 2722b7e5f68e776d18fe901638034e54     | 13            | 5,0           | 0       | 0       | 0       | 0       | 13      | 4,75           |
| 73326828aa5efe1ba096223de496f596     | 52            | 4,8           | 1       | 0       | 0       | 4       | 47      | 4,74           |
| 4c8b28305f570899b6ded964ddd234a9     | 11            | 5,0           | 0       | 0       | 0       | 0       | 11      | 4,72           |


### Comments:
**Objective**: Assign a more robust score to products by considering not just the average review score, but also the number of reviews. This prevents a product with only a few 5-star reviews from appearing “better” than a product with 100 reviews averaging 4.8.<br>

### weighted_rating = (v / (v + m)) * R + (m / (v + m)) * C<br>

`m` = minimum number of reviews required to be “relevant” (here 5)<br>
`v` = number of reviews for the product<br>
`R` = product’s average review score<br>
`C` = global average of all reviews<br>

**Why this ordering?**
- Products with a high average (R) and many reviews (v) tend to rank higher.<br>
- With m = 5, products with fewer than 5 reviews are “pulled” toward the global average (C).<br>
- For products with many reviews, the weighted rating is close to the actual average.<br>
- For products with few reviews, the score is moderated toward the global average to reduce the impact of outliers.

---

## Best Sellers based on IMDB rating
Reusing the previous query as a view let's go to see the best seller considering the reviews

Support VIEW:
```sql
IF OBJECT_ID('vw_product_reviews', 'V') IS NOT NULL
    DROP VIEW vw_product_reviews;
GO

CREATE VIEW vw_product_reviews AS
WITH cte AS (
    -- seleziono tutte le review per ordini con un solo prodotto
    SELECT 
        fr.order_id,
        fr.review_score,
        oi.product_id
    FROM gold.fact_reviews fr
    JOIN gold.fact_order_items oi 
        ON fr.order_id = oi.order_id
    WHERE oi.order_item_id <= 1
),

global_avg_cte AS (
    SELECT AVG(review_score * 1.0) AS global_avg FROM cte -- The global average is 4.107
),

product_reviews AS (
    SELECT 
        dp.product_id,
        COUNT(cte.review_score) AS total_reviews,
        CAST(AVG(cte.review_score * 1.0) AS DECIMAL(3,1)) AS average_score,
        COUNT(CASE WHEN cte.review_score = 1 THEN 1 END) AS _1_Star,
        COUNT(CASE WHEN cte.review_score = 2 THEN 1 END) AS _2_Star,
        COUNT(CASE WHEN cte.review_score = 3 THEN 1 END) AS _3_Star,
        COUNT(CASE WHEN cte.review_score = 4 THEN 1 END) AS _4_Star,
        COUNT(CASE WHEN cte.review_score = 5 THEN 1 END) AS _5_Star
    FROM gold.dim_products dp
    JOIN cte ON dp.product_id = cte.product_id
    GROUP BY dp.product_id
)

SELECT 
    pr.*,
    ROUND((
        (CAST(pr.total_reviews AS FLOAT) / (pr.total_reviews + 5)) * pr.average_score +
        (5.0 / (pr.total_reviews + 5)) * ga.global_avg
    ), 2) AS weighted_rating
FROM product_reviews pr
CROSS JOIN global_avg_cte ga;
```

Query the VIEW:
```sql
SELECT  TOP 10
    ds.seller_id,
	CAST(ROUND(SUM(oi.total_order_payment),0) AS varchar)+' €' AS total_revenue,
    COUNT(DISTINCT pr.product_id) AS total_products,
    SUM(pr.total_reviews) AS total_reviews,
    CAST(CAST(100*(SUM(pr._5_Star) * 1.0 / NULLIF(SUM(pr.total_reviews), 0)) AS DECIMAL(5,2)) AS varchar)+'%' AS percentage_5_Star,
    CAST(AVG(pr.average_score) AS DECIMAL(3,2)) AS avg_score,
    CAST(AVG(pr.weighted_rating) AS DECIMAL(3,2)) AS avg_weighted_rating
FROM dbo.vw_product_reviews pr
JOIN gold.fact_order_items oi ON pr.product_id = oi.product_id
JOIN gold.dim_sellers ds ON oi.seller_id = ds.seller_id
GROUP BY ds.seller_id 
ORDER BY avg_weighted_rating DESC;
```
| seller_id                             | total_revenue | total_products | total_reviews | percentage_5_Star | avg_score | avg_weighted_rating |
|---------------------------------------|---------------|----------------|---------------|------------------|-----------|-------------------|
| 02f5837340d7eb4f653d676c7256523a     | 4464 €       | 3              | 597           | 95,81%           | 4,87      | 4,75              |
| d13e50eaa47b4cbe9eb81465865d8cfc     | 8013 €       | 7              | 2.859         | 90,52%           | 4,79      | 4,67              |
| a3b42d266fa8afc874b909422ce88582     | 921 €         | 1              | 48            | 100,00%          | 5,00      | 4,66              |
| c03121937e54a93fcc1825c3098bbb6e     | 1198 €       | 1              | 49            | 100,00%          | 5,00      | 4,63              |
| 2d518637f53161b973e01f56ea4bb88e     | 1540 €       | 2              | 125           | 91,20%           | 4,92      | 4,61              |
| d4910f1cdcfdabd48d6b316e395d4a23     | 1362 €       | 2              | 111           | 90,09%           | 4,91      | 4,61              |
| b410bdd36d5db7a65dcd42b7ead933b8     | 8734 €       | 2              | 1.768         | 80,88%           | 4,67      | 4,61              |
| 2f4b0d3b9634b647d4edee577d7ebb7e     | 403 €         | 2              | 82            | 89,02%           | 4,91      | 4,58              |
| 41c2bad7229b0c25e6becf179ebf63ff     | 972 €         | 4              | 145           | 93,79%           | 4,96      | 4,56              |
| d94ba08b99bedd6a5f6c875ecc4a6fac     | 778 €         | 1              | 90            | 88,89%           | 4,80      | 4,55              |

### Remarks:
- Next step cross these result with the revenue results to see if high revenue means also high review result

